#!/bin/bash

set -eu

snap install lxd || true

# copy bash completions to host system
cp -a $SNAP/bash_completions/* /usr/share/bash-completion/completions/. || true

mkdir -p /usr/lib/sysctl.d
cat <<EOF>/usr/lib/sysctl.d/60-conjure-up.conf
fs.inotify.max_user_instances=1048576
fs.inotify.max_queued_events=1048576
fs.inotify.max_user_watches=1048576
vm.max_map_count=262144
net.ipv4.ip_forward=1
EOF

sysctl -p /usr/lib/sysctl.d/60-conjure-up.conf

cat <<EOF>/etc/ld.so.conf.d/conjure-up.conf
$SNAP/usr/lib/$(uname -p)-linux-gnu/
EOF

ldconfig
