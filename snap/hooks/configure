#!/bin/bash

LXCBIN=$(which lxc)
LXDBIN=$(which lxd)

if [ "$LXDBIN" = "" ]; then
    sudo snap install lxd || true
    LXCBIN=/snap/bin/lxc
    LXDBIN=/snap/bin/lxd
fi

VERSION=$(LXDBIN --version)

if dpkg --compare-versions "$VERSION" gt "2.2"; then
    if ! $LXCBIN network list | grep -q lxdbr0; then
        # Configure a known address ranges for lxdbr0.
        $LXCBIN network create lxdbr0 \
            ipv4.address=10.0.8.1/24 ipv4.nat=true \
            ipv6.address=none ipv6.nat=false
    fi
else
    # This is OK since the only time we'll hit an earlier version of LXD is on
    # Xenial and it would only be in deb form.
    if ! debconf-show lxd | grep -q 'bridge-ipv4:\strue'; then
        debconf-communicate <<EOF> /dev/null
set lxd/setup-bridge true
set lxd/bridge-domain lxd
set lxd/bridge-name lxdbr0
set lxd/bridge-ipv4 true
set lxd/bridge-ipv4-address 10.0.8.1
set lxd/bridge-ipv4-dhcp-first 10.0.8.3
set lxd/bridge-ipv4-dhcp-last 10.0.8.254
set lxd/bridge-ipv4-dhcp-leases 252
set lxd/bridge-ipv4-netmask 24
set lxd/bridge-ipv4-nat true
set lxd/bridge-ipv6 false
EOF
        rm -rf /etc/default/lxd-bridge
        dpkg-reconfigure lxd --frontend=noninteractive
    fi
fi

# copy bash completions to host system
cp -a $SNAP/bash_completions/* /usr/share/bash-completion/completions/. || true

mkdir -p /usr/lib/sysctl.d
cat <<EOF>/usr/lib/sysctl.d/60-conjure-up.conf
fs.inotify.max_user_instances=1048576
fs.inotify.max_queued_events=1048576
fs.inotify.max_user_watches=1048576
vm.max_map_count=262144
EOF

sysctl -p /usr/lib/sysctl.d/60-conjure-up.conf

ip link add dev conjureup0 type bridge || true
ip addr add 10.99.0.1/24 dev conjureup0 || true
ip link set dev conjureup0 up || true

echo 1 > /proc/sys/net/ipv4/ip_forward

if iptables-save|grep -q "10\.99\.0\.0"; then
    exit 0
fi

iptables -I FORWARD -i conjureup0 -j ACCEPT
iptables -I FORWARD -o conjureup0 -j ACCEPT
iptables -t nat -A POSTROUTING -s 10.99.0.1/24 ! -d 10.99.0.1/24 -j MASQUERADE
iptables -I INPUT -i conjureup0 -p tcp -m tcp --dport 53 -j ACCEPT
iptables -I INPUT -i conjureup0 -p udp -m udp --dport 53 -j ACCEPT
iptables -I INPUT -i conjureup0 -p tcp -m tcp --dport 67 -j ACCEPT
iptables -I INPUT -i conjureup0 -p udp -m udp --dport 67 -j ACCEPT

cat <<EOF>/etc/ld.so.conf.d/conjure-up.conf
$SNAP/usr/lib/$(uname -p)-linux-gnu/
EOF

sudo ldconfig
